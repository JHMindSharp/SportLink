{% extends 'base.html' %}

{% block title %}Profil de {{ user.username }} - SportLink{% endblock %}

{% block content %}
{% if current_user.birth_date is none or current_user.sex is none %}
    <div class="welcome-message">
        <h2>Bienvenue sur SportLink !</h2>
        <p>Pour profiter pleinement de l'application, veuillez <a href="{{ url_for('profile.complete_profile') }}">compléter votre profil</a>.</p>
    </div>
{% endif %}

<div class="profile-container">
    <!-- Couverture et photo de profil -->
    <div class="profile-header">
        <div class="cover-photo" style="background-image: url('{{ url_for('main.uploaded_file', filename='covers/' ~ user.cover_image) if user.cover_image else url_for('static', filename='images/default_cover.jpg') }}');">
            <!-- Bouton pour changer la photo de couverture (retiré selon votre demande) -->
            <!--
            {% if current_user == user %}
                <button class="change-cover-btn" onclick="openCoverPhotoModal()">Modifier la couverture</button>
            {% endif %}
            -->
        </div>
        <div class="profile-photo" style="background-image: url('{{ url_for('main.uploaded_file', filename='profiles/' ~ user.profile_image) if user.profile_image else url_for('static', filename='images/default_profile.jpg') }}');">
            <!-- Bouton pour changer la photo de profil (retiré selon votre demande) -->
            <!--
            {% if current_user == user %}
                <button class="change-profile-btn" onclick="openProfilePhotoModal()">Modifier la photo</button>
            {% endif %}
            -->
        </div>
        <div class="user-info">
            <h1>{{ user.first_name }} {{ user.last_name }}</h1>
            <p>{{ user.city }}, {{ user.country }}</p>
            <!-- Boutons d'action -->
            <div class="action-buttons">
                {% if current_user != user %}
                    <!-- Bouton pour ajouter en ami ou envoyer un message -->
                    {% if current_user.is_friend(user) %}
                        <button class="btn-secondary" onclick="window.location.href='{{ url_for('messages.send_message', user_id=user.id) }}'">Envoyer un message</button>
                    {% else %}
                        <form action="{{ url_for('profile.add_friend', user_id=user.id) }}" method="POST">
                            {{ form.hidden_tag() }}
                            <button type="submit" class="btn-primary">Ajouter en ami</button>
                        </form>
                    {% endif %}
                {% else %}
                    <!-- Bouton pour modifier le profil -->
                    <a href="{{ url_for('profile.edit_profile') }}" class="btn-secondary">Mise à jour de mon profil</a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Navigation du profil -->
    <nav class="profile-nav">
        <ul>
            <li><a href="{{ url_for('profile.profile') }}" class="active">Publications</a></li>
            <li><a href="{{ url_for('profile.profile') }}">Profil</a></li>
            <li><a href="{{ url_for('profile.list_friends') }}">Amis</a></li>
            <li><a href="{{ url_for('profile.photos', user_id=user.id) }}">Photos</a></li>
            <li><a href="{{ url_for('profile.settings') }}">Paramètres</a></li>
        </ul>
    </nav>

    <!-- Contenu principal -->
    <div class="main-content">
        <!-- Section des publications -->
        <div class="posts-section">
            <!-- Formulaire de création de publication -->
            {% if current_user == user %}
                <div class="create-post" onclick="window.location.href='{{ url_for('posts.create_post') }}'">
                    <p>Quoi de neuf, {{ user.username }} ?</p>
                </div>
            {% endif %}

            <!-- Liste des publications -->
            {% for post in posts %}
                <div class="post">
                    <div class="post-header">
                        <img src="{{ url_for('main.uploaded_file', filename='profiles/' ~ post.author.profile_image) if post.author.profile_image else url_for('static', filename='images/default_profile.jpg') }}" alt="{{ post.author.username }}">
                        <div>
                            <span class="author-name">{{ post.author.username }}</span>
                            <span class="post-date">{{ post.created_at.strftime('%d %B %Y à %H:%M') }}</span>
                        </div>
                    </div>
                    <div class="post-content">
                        {% if post.title %}
                            <h3>{{ post.title }}</h3>
                        {% endif %}
                        <p>{{ post.content }}</p>
                        <!-- Affichage des médias -->
                        {% if post.image %}
                            <img src="{{ url_for('main.uploaded_file', filename=post.image) }}" alt="Image de la publication">
                        {% endif %}
                        {% if post.video %}
                            <video controls>
                                <source src="{{ url_for('main.uploaded_file', filename=post.video) }}" type="video/mp4">
                            </video>
                        {% endif %}
                        {% if post.music %}
                            <audio controls>
                                <source src="{{ url_for('main.uploaded_file', filename=post.music) }}" type="audio/mpeg">
                                Votre navigateur ne supporte pas la balise audio.
                            </audio>
                        {% endif %}
                    </div>
                    <!-- Boutons d'interaction -->
                    <div class="post-actions">
                        <button class="like-btn" onclick="likePost({{ post.id }})">J'aime</button>
                        <button class="comment-btn" onclick="commentPost({{ post.id }})">Commenter</button>
                        {% if current_user == post.author %}
                            <form action="{{ url_for('posts.delete_post', post_id=post.id) }}" method="POST">
                                {{ form.hidden_tag() }}
                                <button type="submit" class="delete-btn">Supprimer</button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Section latérale (Informations, Amis, Photos) -->
        <aside class="sidebar">
            <!-- Informations personnelles -->
            <div class="info-card">
                <h3>Informations</h3>
                <ul>
                    <li><strong>Âge :</strong> {{ user.age }} ans</li>
                    <li><strong>Sexe :</strong> {{ user.sex }}</li>
                    <li><strong>Email :</strong> {{ user.email if user.display_email else 'Privé' }}</li>
                    <li><strong>Téléphone :</strong> {{ user.phone if user.display_phone else 'Privé' }}</li>
                    <!-- Affichage des sports et niveaux -->
                    <li><strong>Sports :</strong>
                        <ul>
                            {% for user_sport in user.sports %}
                                <li>{{ user_sport.sport.name }} - Niveau {{ user_sport.level }}/5</li>
                            {% endfor %}
                        </ul>
                    </li>
                </ul>
            </div>

            <!-- Liste des amis -->
            <div class="friends-card">
                <h3>Amis</h3>
                <div class="friends-list">
                    {% for friend in user.friends %}
                        <a href="{{ url_for('profile.profile', user_id=friend.id) }}" class="friend">
                            <img src="{{ url_for('main.uploaded_file', filename='profiles/' ~ friend.profile_image) if friend.profile_image else url_for('static', filename='images/default_profile.jpg') }}" alt="{{ friend.username }}">
                            <span>{{ friend.username }}</span>
                        </a>
                    {% endfor %}
                </div>
                <a href="{{ url_for('profile.list_friends') }}" class="see-all">Voir tous les amis</a>
            </div>

            <!-- Photos récentes -->
            <div class="photos-card">
                <h3>Photos</h3>
                <div class="photos-grid">
                    {% for post in posts %}
                        {% if post.image %}
                            <img src="{{ url_for('main.uploaded_file', filename=post.image) }}" alt="Photo">
                        {% endif %}
                    {% endfor %}
                </div>
                <a href="{{ url_for('profile.photos', user_id=user.id) }}" class="see-all">Voir toutes les photos</a>
            </div>
        </aside>
    </div>
</div>

{% endblock %}
